<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKUNK - Horror Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- STYLE GLOBAL --- */
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; user-select: none; -webkit-user-select: none; touch-action: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* --- UI ECRANS --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; color: #eee; text-align: center; background: #050505; transition: opacity 0.5s; }
        
        /* ECRAN TITRE */
        #title-screen { background: radial-gradient(circle, #1a1a1a, #000000); }
        #title-screen h1 { font-size: 4rem; letter-spacing: 5px; margin: 0; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .menu-btn { margin-top: 20px; padding: 12px 30px; font-size: 1.2rem; background: #222; border: 1px solid #555; color: white; cursor: pointer; font-family: inherit; border-radius: 5px; }
        .menu-btn:active { background: #444; }
        .credits { position: absolute; bottom: 10px; right: 15px; font-size: 0.8rem; color: #666; }

        /* PARAMETRES MODAL */
        #settings-modal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; background: #111; border: 2px solid #444; padding: 20px; z-index: 30; color: white; text-align: center; border-radius: 10px; }
        .slider-container { margin: 20px 0; }
        input[type=range] { width: 100%; }

        /* LOADING */
        #loading-screen { display: none; background: #000; color: #888; }
        .loader-spinner { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ECRAN NIV 2 */
        #lvl2-screen { display: none; background: black; color: white; }
        #lvl2-screen h2 { font-size: 3rem; color: yellow; text-shadow: 0 0 20px orange; }

        /* --- HUD JEU --- */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 10; }
        
        /* Objectif */
        #objective-box { position: absolute; top: 10px; left: 10px; color: rgba(255,255,255,0.7); font-size: 0.9rem; text-align: left; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        
        /* Reticule */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); }
        
        /* Message interaction */
        #interaction-msg { position: absolute; top: 60%; width: 100%; text-align: center; color: white; font-size: 1rem; text-shadow: 1px 1px 2px black; display: none; }

        /* Barre de Peur */
        #fear-container { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: #333; border: 1px solid #555; border-radius: 5px; overflow: hidden; }
        #fear-bar { width: 0%; height: 100%; background: linear-gradient(90deg, green, yellow, red); transition: width 0.2s; }
        #fear-label { position: absolute; bottom: 32px; left: 50%; transform: translateX(-50%); color: #aaa; font-size: 0.8rem; }

        /* --- CONTROLES VISUELS --- */
        /* Joystick Gauche Uniquement */
        .joy-container { position: absolute; bottom: 40px; left: 30px; width: 90px; height: 90px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }
        .joy-stick { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: transform 0.1s ease-out; }
        
        /* Zones tactiles invisibles */
        .touch-zone-left { position: absolute; bottom: 0; left: 0; height: 60%; width: 40%; z-index: 15; /*background: rgba(0,255,0,0.1);*/ }
        .touch-zone-right { position: absolute; top: 0; right: 0; height: 100%; width: 60%; z-index: 15; /*background: rgba(0,0,255,0.1);*/ }
    </style>
</head>
<body>

    <div id="title-screen" class="screen">
        <h1>SKUNK</h1>
        <button class="menu-btn" onclick="startSequence()">JOUER</button>
        <button class="menu-btn" onclick="openSettings()">PARAMÈTRES</button>
        <div class="credits">a MR Production</div>
    </div>

    <div id="settings-modal">
        <h3>PARAMÈTRES</h3>
        <div class="slider-container">
            <label>Sensibilité Caméra</label><br>
            <input type="range" id="sens-slider" min="1" max="10" value="4">
        </div>
        <button class="menu-btn" onclick="closeSettings()">FERMER</button>
    </div>

    <div id="loading-screen" class="screen">
        <div class="loader-spinner"></div>
        <p>Marion se prépare...</p>
    </div>

     <div id="lvl2-screen" class="screen">
        <h2>NIVEAU 2</h2>
        <p>Appel en cours...</p>
        <p style="font-size: 1rem; color: #888;">COMING SOON</p>
    </div>

    <div id="game-container"></div>
    
    <div id="hud">
        <div id="objective-box">OBJECTIF:<br>- Trouver une lampe<br>- Trouver la Bobo Banane</div>
        <div id="crosshair"></div>
        <div id="interaction-msg"></div>
        
        <div id="fear-label">PEUR DE MOUFETTE</div>
        <div id="fear-container"><div id="fear-bar"></div></div>

        <div id="joy-container" class="joy-container"><div class="joy-stick" id="joy-stick"></div></div>
    </div>

    <div id="zone-left" class="touch-zone-left"></div>
    <div id="zone-right" class="touch-zone-right"></div>

    <script>
        // --- VARIABLES GLOBALES ---
        let camera, scene, renderer;
        let walls = []; 
        let interactables = [];
        let banana, flashlightItem;
        let playerSpotlight;
        let hasFlashlight = false;
        let gameState = 'menu';

        // Paramètres Joueur
        const playerHeight = 0.4; 
        const baseSpeed = 0.05; // Vitesse de base ralentie
        let currentSpeed = baseSpeed;
        const playerRadius = 0.3;
        
        // Système de Peur
        let fearLevel = 0; // 0 à 1
        const fearDistance = 8.0; // Distance à laquelle la peur commence
        
        // Contrôles
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let lookSensitivity = 0.003; 
        let yaw = Math.PI; // Rotation horizontale
        let pitch = 0; // Rotation verticale

        // Joystick Logic
        const stickVisual = document.getElementById('joy-stick');
        let joyCenter = { x: 0, y: 0 };
        
        // Audio
        let audioCtx = null;

        // --- GENERATEUR DE TEXTURES (CANVAS) ---
        function createWoodTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            // Fond marron foncé
            ctx.fillStyle = '#3e2723'; 
            ctx.fillRect(0,0,512,512);
            // Lignes (planches)
            ctx.strokeStyle = '#281a16';
            ctx.lineWidth = 3;
            for(let i=0; i<512; i+=64) {
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(512, i); ctx.stroke();
                // Quelques traits verticaux aléatoires
                for(let j=0; j<8; j++) {
                    let x = Math.random() * 512;
                    ctx.beginPath(); ctx.moveTo(x, i); ctx.lineTo(x, i+64); ctx.stroke();
                }
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        function createWallTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#b0bec5'; // Gris bleu sale
            ctx.fillRect(0,0,512,512);
            // Bruit (saleté)
            for(let i=0; i<5000; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#90a4ae' : '#cfd8dc';
                ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- GESTION DES MENUS ---
        function openSettings() {
            document.getElementById('settings-modal').style.display = 'block';
        }
        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
            // Mettre à jour la sensibilité
            const val = document.getElementById('sens-slider').value;
            lookSensitivity = val * 0.0008;
        }

        function startSequence() {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            gameState = 'loading';
            
            // Audio simple (battement de coeur synthétisé plus tard)
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                initGame();
                gameState = 'playing';
            }, 2000);
        }

        // --- INITIALISATION JEU ---
        function initGame() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x05070a); // Bleu nuit très sombre
            scene.fog = new THREE.FogExp2(0x05070a, 0.1); // Brouillard moins dense pour voir les pièces

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50);
            camera.rotation.order = "YXZ";
            camera.position.set(2, playerHeight, 2); 

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // ECLAIRAGE
            // Lumière ambiante froide (Lune) - On voit un peu sans lampe
            const moonLight = new THREE.AmbientLight(0x404060, 0.6); 
            scene.add(moonLight);

            // Lampe Torche Joueur (désactivée au début)
            playerSpotlight = new THREE.SpotLight(0xffffee, 0, 20, Math.PI/6, 0.3, 1);
            playerSpotlight.position.set(0,0,0);
            playerSpotlight.target.position.set(0,0,-1);
            playerSpotlight.castShadow = true;
            camera.add(playerSpotlight);
            camera.add(playerSpotlight.target);
            scene.add(camera);

            createHouse();
            setupControls();

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function createHouse() {
            const texFloor = createWoodTexture();
            texFloor.repeat.set(4, 4);
            const texWall = createWallTexture();
            texWall.repeat.set(2, 1);

            // MATERIAUX
            const matFloor = new THREE.MeshStandardMaterial({ map: texFloor, roughness: 0.8 });
            const matWall = new THREE.MeshStandardMaterial({ map: texWall, roughness: 1.0 });
            const matCeiling = new THREE.MeshStandardMaterial({ color: 0x111111 });
            const matFurniture = new THREE.MeshStandardMaterial({ color: 0x3e2723 }); // Bois sombre meuble

            function makeBox(x, y, z, w, h, d, mat, isSolid) {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
                mesh.position.set(x, y, z);
                mesh.castShadow = true; mesh.receiveShadow = true;
                scene.add(mesh);
                if (isSolid) walls.push(new THREE.Box3().setFromObject(mesh));
                return mesh;
            }

            // SOL GENERAL
            makeBox(0, -0.1, 10, 40, 0.2, 50, matFloor, false);
            // PLAFOND
            makeBox(0, 3.1, 10, 40, 0.2, 50, matCeiling, true);

            // --- CHAMBRE (Spawn) ---
            // Murs
            makeBox(2.5, 1.5, -0.1, 5.2, 3, 0.2, matWall, true); // Nord
            makeBox(-0.1, 1.5, 2.5, 0.2, 3, 5.2, matWall, true); // Ouest
            makeBox(5.1, 1.5, 2.5, 0.2, 3, 5.2, matWall, true); // Est
            makeBox(1, 1.5, 5.1, 2, 3, 0.2, matWall, true); // Sud (Porte)
            makeBox(4, 1.5, 5.1, 2, 3, 0.2, matWall, true); 

            // Meubles Chambre
            // Lit (tête de lit + matelas)
            makeBox(3.5, 0.6, 0.5, 2.5, 0.8, 0.2, matFurniture, true); // Tête
            makeBox(3.5, 0.3, 2.0, 2.5, 0.5, 3.0, new THREE.MeshStandardMaterial({color:0x550000}), true); // Lit

            // --- COULOIR ---
            makeBox(-0.1, 1.5, 10, 0.2, 3, 10, matWall, true); // Gauche
            makeBox(5.1, 1.5, 10, 0.2, 3, 10, matWall, true); // Droite

            // --- SALON (Zone Banane) ---
            makeBox(-10, 1.5, 20, 1, 3, 20, matWall, true); // Mur Ouest Salon
            makeBox(15, 1.5, 20, 1, 3, 20, matWall, true); // Mur Est Salon
            makeBox(2.5, 1.5, 30, 26, 3, 1, matWall, true); // Mur Fond Salon

            // Meubles Salon
            makeBox(2.5, 0.4, 25, 3, 0.5, 1.5, matFurniture, true); // Table basse
            makeBox(2.5, 0.6, 28, 5, 0.8, 2, new THREE.MeshStandardMaterial({color:0x223322}), true); // Canapé

            // --- ITEMS ---
            
            // Lampe Torche (Sur le lit)
            const flashGeo = new THREE.CylinderGeometry(0.04, 0.06, 0.2, 16);
            flashGeo.rotateX(Math.PI/2);
            flashlightItem = new THREE.Mesh(flashGeo, new THREE.MeshStandardMaterial({color:0xff0000}));
            flashlightItem.position.set(3.5, 0.6, 2.0);
            flashlightItem.userData = { type: 'flashlight' };
            scene.add(flashlightItem);
            interactables.push(flashlightItem);

            // BOBO BANANE
            const banGeo = new THREE.TorusKnotGeometry(0.3, 0.1, 64, 8, 2, 3);
            const banMat = new THREE.MeshPhongMaterial({ color: 0xffff00, emissive: 0xaa8800, shininess: 100 });
            banana = new THREE.Mesh(banGeo, banMat);
            banana.position.set(10, 0.5, 25); // Coin du salon
            banana.userData = { type: 'banana' };
            scene.add(banana);
            interactables.push(banana);
            
            // Lumière Banane
            const bLight = new THREE.PointLight(0xffff00, 1, 5);
            bLight.position.set(10, 1, 25);
            scene.add(bLight);
        }

        // --- CONTROLES V2 ---
        function setupControls() {
            const zoneL = document.getElementById('zone-left');
            const zoneR = document.getElementById('zone-right');
            
            // Calibration Joystick
            setTimeout(() => {
                const rect = document.getElementById('joy-container').getBoundingClientRect();
                joyCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
            }, 500);

            // 1. JOYSTICK GAUCHE (Mouvement)
            let touchIdL = null;
            zoneL.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const t = e.changedTouches[0];
                touchIdL = t.identifier;
                updateJoystick(t.clientX, t.clientY);
            }, {passive:false});

            zoneL.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for(let t of e.changedTouches) {
                    if(t.identifier === touchIdL) updateJoystick(t.clientX, t.clientY);
                }
            }, {passive:false});

            zoneL.addEventListener('touchend', (e) => {
                e.preventDefault();
                for(let t of e.changedTouches) {
                    if(t.identifier === touchIdL) {
                        touchIdL = null;
                        moveForward = moveBackward = moveLeft = moveRight = false;
                        stickVisual.style.transform = `translate(-50%, -50%)`;
                    }
                }
            });

            function updateJoystick(cx, cy) {
                let dx = cx - joyCenter.x;
                let dy = cy - joyCenter.y;
                const dist = Math.sqrt(dx*dx+dy*dy);
                const maxRad = 35; 
                
                // Clamp visuel
                if(dist > maxRad) { dx = (dx/dist)*maxRad; dy = (dy/dist)*maxRad; }
                stickVisual.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

                // Logique
                const threshold = 10;
                moveForward = dy < -threshold;
                moveBackward = dy > threshold;
                moveLeft = dx < -threshold;
                moveRight = dx > threshold;
            }

            // 2. ECRAN DROIT (Regard)
            let touchIdR = null;
            let lastX = 0, lastY = 0;
            
            zoneR.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const t = e.changedTouches[0];
                touchIdR = t.identifier;
                lastX = t.clientX; lastY = t.clientY;
            }, {passive:false});

            zoneR.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for(let t of e.changedTouches) {
                    if(t.identifier === touchIdR) {
                        let dx = t.clientX - lastX;
                        let dy = t.clientY - lastY;
                        
                        yaw -= dx * lookSensitivity;
                        pitch -= dy * lookSensitivity;
                        pitch = Math.max(-Math.PI/2.2, Math.min(Math.PI/2.2, pitch));
                        
                        lastX = t.clientX; lastY = t.clientY;
                    }
                }
            }, {passive:false});

            zoneR.addEventListener('touchend', (e) => { touchIdR = null; });
        }

        // --- GAME LOOP ---
        function checkCollision(pos) {
            const box = new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(playerRadius, playerHeight, playerRadius));
            for(let w of walls) if(box.intersectsBox(w)) return true;
            return false;
        }

        function updateFear() {
            if(!banana) return;
            const dist = camera.position.distanceTo(banana.position);
            
            // Calcul Peur
            if(dist < fearDistance) {
                fearLevel = 1 - (dist / fearDistance); // 0 (loin) à 1 (très près)
            } else {
                fearLevel = 0;
            }

            // UI Bar Update
            const bar = document.getElementById('fear-bar');
            bar.style.width = (fearLevel * 100) + '%';
            
            // Effets de Peur
            // 1. Ralentissement
            currentSpeed = baseSpeed * (1 - (fearLevel * 0.6)); // Ralentit jusqu'à 40% de la vitesse
            
            // 2. Tremblement Caméra (Si peur > 0.3)
            if(fearLevel > 0.3) {
                const shake = fearLevel * 0.02;
                camera.position.x += (Math.random()-0.5)*shake;
                camera.position.z += (Math.random()-0.5)*shake;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(gameState !== 'playing') return;

            updateFear();

            // Mouvement
            camera.rotation.y = yaw;
            camera.rotation.x = pitch;

            const dir = new THREE.Vector3();
            const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
            const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);

            if(moveForward) dir.add(fwd);
            if(moveBackward) dir.sub(fwd);
            if(moveLeft) dir.sub(rgt);
            if(moveRight) dir.add(rgt);

            if(dir.length() > 0) {
                dir.normalize().multiplyScalar(currentSpeed);
                const oldPos = camera.position.clone();
                camera.position.x += dir.x;
                if(checkCollision(camera.position)) camera.position.x = oldPos.x;
                camera.position.z += dir.z;
                if(checkCollision(camera.position)) camera.position.z = oldPos.z;
                
                // Bobbing
                camera.position.y = playerHeight + Math.sin(Date.now()*0.015)*0.03;
            }

            // Gestion Lampe
            if(hasFlashlight) {
                playerSpotlight.position.copy(camera.position);
                playerSpotlight.position.y -= 0.1;
                playerSpotlight.target.position.copy(camera.position).add(fwd);
                playerSpotlight.intensity = 1.5 - (Math.random()*0.1); // Léger scintillement
            }

            // Interactions
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(interactables);
            const msg = document.getElementById('interaction-msg');
            msg.style.display = 'none';

            if(hits.length > 0 && hits[0].distance < 2) {
                const obj = hits[0].object;
                if(obj.userData.type === 'flashlight' && !hasFlashlight) {
                    msg.style.display = 'block';
                    msg.textContent = "TAPOTER POUR PRENDRE LA LAMPE";
                    // Interaction simple: si on touche l'écran droit (regard) sans bouger beaucoup
                    if(document.getElementById('zone-right').matches(':active')) {
                        hasFlashlight = true;
                        scene.remove(obj);
                        interactables = interactables.filter(i=>i!==obj);
                        // Son "click" simulé visuellement par un flash
                        scene.background = new THREE.Color(0x222222);
                        setTimeout(() => scene.background = new THREE.Color(0x05070a), 100);
                    }
                } else if(obj.userData.type === 'banana' && hasFlashlight) {
                    msg.style.display = 'block';
                    msg.textContent = "LA BOBO BANANE !";
                    if(hits[0].distance < 1.2) {
                        gameState = 'finished';
                        document.getElementById('hud').style.display = 'none';
                        document.getElementById('lvl2-screen').style.display = 'flex';
                    }
                }
            }
            
            // Animation Banane
            if(banana) banana.rotation.y += 0.02;

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
